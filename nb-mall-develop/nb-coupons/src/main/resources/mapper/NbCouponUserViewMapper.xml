<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright (c) 2013 大连锦霖科技有限公司
   -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "mybatis-3-mapper.dtd">
<!--table nb_coupons_users-->
<mapper namespace="NbCouponsUserView">
    <resultMap id="nbCouponsUserViewMap" type="NbCouponsUserView">
        <id property="id" column="id"/>
        <result property="couponId" column="couponId"/>
        <result property="cpName" column="cpName"/>
        <result property="userId" column="userId"/>
        <result property="status" column="status"/>
        <result property="amount" column="amount"/>
        <result property="categoryId" column="categoryId"/>
        <result property="term" column="term"/>
    </resultMap>

    <select id="queryCouponsAllByUser" resultMap="nbCouponsUserViewMap">
            SELECT * FROM (
            SELECT a.id,a.userId,a.couponId,a.status,b.amount,b.categoryId,b.cpName,b.startTime,b.endTime,b.term,b.status AS coustatus FROM nb_coupons_users a LEFT JOIN nb_coupons b
            ON a.couponId = b.id) c
            where
             <![CDATA[  startTime <= #{startTime} and endTime >= #{endTime}   ]]>
            and status = #{status}
            and coustatus = 2
            and userId = #{userId}
            GROUP BY userId,couponId
    </select>

</mapper>